---
import Pill from "./Pill.astro";
import { tagHierarchy } from "../tagHierarchy";

const mainTags = Object.keys(tagHierarchy);
---

<div class="tags-filter space-y-4">
	<!-- Tags principaux -->
	<div>
		<ul class="flex flex-wrap gap-4 justify-center">
			{
				mainTags.map((tag) => (
					<li>
						<label class="cursor-pointer">
							<input
								type="checkbox"
								name="main-tag-filter"
								value={tag}
								class="hidden main-tag-checkbox"
								data-category={tag}
							/>
							<a class="sanchez inline-flex items-center pill-container">
								<Pill>{tagHierarchy[tag].label}</Pill>
							</a>
						</label>
					</li>
				))
			}
		</ul>
	</div>

	<!-- Sous-tags niveau 2 -->
	{
		mainTags.map((mainTag) => (
			<div
				class="subtags-container hidden animate-container"
				data-parent={mainTag}
			>
				<ul class="flex flex-wrap gap-4 justify-center">
					{Object.entries(tagHierarchy[mainTag].subtags || {}).map(
						([subtagKey, subtag]) => (
							<li>
								<label class="cursor-pointer">
									<input
										type="checkbox"
										name="subtag-filter"
										value={subtagKey}
										data-parent={mainTag}
										class="hidden subtag-checkbox"
									/>
									<a class="sanchez inline-flex items-center pill-container">
										<Pill>{subtag.label}</Pill>
									</a>
								</label>
							</li>
						),
					)}
				</ul>
			</div>
		))
	}

	<!-- Sous-tags niveau 3 -->
	{
		mainTags.map((mainTag) =>
			Object.entries(tagHierarchy[mainTag].subtags || {}).map(
				([subtagKey, subtag]) => (
					<div
						class="subsubtags-container hidden animate-container"
						data-parent={`${mainTag}-${subtagKey}`}
					>
						<ul class="flex flex-wrap gap-4 justify-center">
							{Object.entries(subtag.subtags || {}).map(
								([subsubtagKey, subsubtag]) => (
									<li>
										<label class="cursor-pointer">
											<input
												type="checkbox"
												name="subsubtag-filter"
												value={subsubtagKey}
												data-parent={`${mainTag}-${subtagKey}`}
												class="hidden subsubtag-checkbox"
											/>
											<a class="sanchez inline-flex items-center pill-container">
												<Pill>{subsubtag.label}</Pill>
											</a>
										</label>
									</li>
								),
							)}
						</ul>
					</div>
				),
			),
		)
	}
</div>

<style>
	.pill-container :global(.brutal-pill) {
		transform: scale(1.5);
		margin-bottom: 0.5rem;
		transition: all 0.2s ease-in-out;
	}

	.pill-container:hover :global(.brutal-pill) {
		transform: scale(1.5) translateX(-15px) rotate(-10deg);
	}

	input:checked + a :global(.brutal-pill) {
		background-color: black;
		color: white;
		transform: scale(1.5) translateY(-5px);
	}

	.animate-container {
		opacity: 0;
		transform: translateY(-10px);
		transition: all 0.3s ease-out;
	}

	.animate-container:not(.hidden) {
		opacity: 1;
		transform: translateY(0);
	}

	:global(.infinite-hidden) {
		display: none;
	}
</style>

<script>
	import { initializeFilters } from "../../utils/filterPosts";

	function resetFilters() {
		// Réinitialiser les checkboxes
		const checkboxes = document.querySelectorAll<HTMLInputElement>(
			'input[type="checkbox"]',
		);
		checkboxes.forEach((checkbox) => {
			checkbox.checked = false;
		});

		// Cacher tous les conteneurs de sous-tags
		const subtagContainers = document.querySelectorAll(
			".subtags-container, .subsubtags-container",
		);
		subtagContainers.forEach((container) => {
			container.classList.add("hidden");
		});

		// Réinitialiser l'affichage des posts
		const posts = document.querySelectorAll(".post");
		posts.forEach((post) => {
			post.classList.remove("hidden");
		});
	}

	function setupFilters() {
		const mainTagCheckboxes = document.querySelectorAll(".main-tag-checkbox");
		const subtagCheckboxes = document.querySelectorAll(".subtag-checkbox");
		const subsubtagCheckboxes = document.querySelectorAll(
			".subsubtag-checkbox",
		);

		// Gestion des tags principaux
		mainTagCheckboxes.forEach((checkbox) => {
			checkbox.addEventListener("change", (e) => {
				const target = e.target as HTMLInputElement;
				const category = target.dataset.category;
				const subtagsContainer = document.querySelector(
					`.subtags-container[data-parent="${category}"]`,
				);

				if (target.checked) {
					subtagsContainer?.classList.remove("hidden");
				} else {
					subtagsContainer?.classList.add("hidden");
					// Décocher et cacher les sous-niveaux
					const relatedSubtags = document.querySelectorAll(
						`input[data-parent="${category}"]`,
					);
					relatedSubtags.forEach((subtag) => {
						(subtag as HTMLInputElement).checked = false;
					});
					document
						.querySelectorAll(
							`.subsubtags-container[data-parent^="${category}-"]`,
						)
						.forEach((container) => container.classList.add("hidden"));
				}
			});
		});

		// Gestion des sous-tags niveau 2
		subtagCheckboxes.forEach((checkbox) => {
			checkbox.addEventListener("change", (e) => {
				const target = e.target as HTMLInputElement;
				const parent = target.dataset.parent;
				const subtagKey = target.value;
				const subsubtagsContainer = document.querySelector(
					`.subsubtags-container[data-parent="${parent}-${subtagKey}"]`,
				);

				if (target.checked) {
					subsubtagsContainer?.classList.remove("hidden");
				} else {
					subsubtagsContainer?.classList.add("hidden");
					// Décocher les sous-sous-tags
					const relatedSubsubtags = document.querySelectorAll(
						`input[data-parent="${parent}-${subtagKey}"]`,
					);
					relatedSubsubtags.forEach((subsubtag) => {
						(subsubtag as HTMLInputElement).checked = false;
					});
				}
			});
		});

		// Initialiser les filtres
		initializeFilters();
	}

	// Nettoyer avant de quitter la page
	document.addEventListener("astro:before-preparation", resetFilters);

	// Initialiser après le chargement de la page
	document.addEventListener("astro:page-load", setupFilters);

	// Fallback pour le chargement initial
	if (document.readyState === "loading") {
		document.addEventListener("DOMContentLoaded", setupFilters);
	} else {
		setupFilters();
	}
</script>
