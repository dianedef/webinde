<button
	id="themeToggle"
	class="w-10 h-10 md:w-8 md:h-8 flex items-center justify-center hover:text-green transition-colors duration-200 touch-manipulation"
	aria-label="Basculer le thème"
>
	<div id="sun" class="i-uil-sun w-8 h-8 md:w-6 md:h-6 hidden"></div>
	<div id="moon" class="i-uil-moon w-8 h-8 md:w-6 md:h-6"></div>
</button>

<script is:inline>
	let isInitialized = false;

	// Fonction pour obtenir le thème
	function getTheme() {
		if (
			typeof localStorage !== "undefined" &&
			localStorage.getItem("theme")
		) {
			return localStorage.getItem("theme");
		}
		if (window.matchMedia("(prefers-color-scheme: dark)").matches) {
			return "dark";
		}
		return "light";
	}

	// Fonction pour appliquer le thème
	function applyTheme(theme) {
		console.log("Applying theme:", theme);
		if (theme === "dark") {
			document.documentElement.classList.add("dark");
		} else {
			document.documentElement.classList.remove("dark");
		}
	}

	// Fonction pour mettre à jour les icônes
	function updateIcons() {
		const isDark = document.documentElement.classList.contains("dark");
		const sunIcon = document.getElementById("sun");
		const moonIcon = document.getElementById("moon");

		console.log("Updating icons, isDark:", isDark);
		console.log("Sun icon:", sunIcon);
		console.log("Moon icon:", moonIcon);

		if (isDark) {
			sunIcon?.classList.remove("hidden");
			moonIcon?.classList.add("hidden");
		} else {
			sunIcon?.classList.add("hidden");
			moonIcon?.classList.remove("hidden");
		}
	}

	// Fonction pour gérer le clic
	function handleToggleClick(e) {
		console.log("Toggle clicked");
		e.preventDefault();
		e.stopPropagation();

		const element = document.documentElement;
		const isDark = element.classList.contains("dark");
		const newTheme = isDark ? "light" : "dark";

		console.log("Current theme:", isDark ? "dark" : "light");
		console.log("Switching to:", newTheme);

		localStorage.setItem("theme", newTheme);
		applyTheme(newTheme);
		updateIcons();

		// Déclencher l'événement de changement de thème
		window.dispatchEvent(
			new CustomEvent("theme-changed", {
				detail: { isDark: !isDark },
			}),
		);
	}

	// Fonction d'initialisation
	function initThemeToggle() {
		console.log("Initializing theme toggle");
		if (isInitialized) {
			console.log("Already initialized, skipping");
			return;
		}

		const button = document.getElementById("themeToggle");
		if (!button) {
			console.log("Button not found");
			return;
		}

		console.log("Found button:", button);

		// Supprimer les anciens écouteurs si ils existent
		button.removeEventListener("click", handleToggleClick);
		button.removeEventListener("touchend", handleToggleClick);

		// Ajouter les nouveaux écouteurs
		button.addEventListener("click", handleToggleClick);
		button.addEventListener("touchend", handleToggleClick);

		// Appliquer le thème initial
		applyTheme(getTheme());
		updateIcons();

		isInitialized = true;
		console.log("Initialization complete");
	}

	// Initialisation immédiate
	if (document.readyState === "loading") {
		document.addEventListener("DOMContentLoaded", () => {
			console.log("DOM Content Loaded");
			initThemeToggle();
		});
	} else {
		console.log("Document already loaded");
		initThemeToggle();
	}

	// Réinitialisation après les transitions de page
	document.addEventListener("astro:page-load", () => {
		console.log("Astro page load");
		isInitialized = false; // Réinitialiser le flag
		initThemeToggle();
	});

	document.addEventListener("astro:after-swap", () => {
		console.log("Astro after swap");
		applyTheme(getTheme());
		updateIcons();
	});
</script>
