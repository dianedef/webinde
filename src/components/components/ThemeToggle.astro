<button
	id="themeToggle"
	class="w-8 h-8 flex items-center justify-center hover:text-green transition-colors duration-200"
>
	<div id="sun" class="i-uil-sun w-6 h-6 hidden"></div>
	<div id="moon" class="i-uil-moon w-6 h-6"></div>
</button>

<!-- Script qui s'exécute immédiatement pour éviter le flash -->
<script is:inline data-astro-rerun>
	(function () {
		function getTheme() {
			if (
				typeof localStorage !== "undefined" &&
				localStorage.getItem("theme")
			) {
				return localStorage.getItem("theme");
			}
			if (window.matchMedia("(prefers-color-scheme: dark)").matches) {
				return "dark";
			}
			return "light";
		}

		function applyTheme(theme) {
			if (theme === "dark") {
				document.documentElement.classList.add("dark");
			} else {
				document.documentElement.classList.remove("dark");
			}
		}

		// Appliquer le thème initial
		const theme = getTheme();
		applyTheme(theme);

		// Appliquer le thème avant le swap pour éviter le flash
		document.addEventListener("astro:before-swap", (ev) => {
			const newDocument = ev.newDocument;
			if (getTheme() === "dark") {
				newDocument.documentElement.classList.add("dark");
			} else {
				newDocument.documentElement.classList.remove("dark");
			}
		});

		// Réappliquer le thème après le swap pour s'assurer de la cohérence
		document.addEventListener("astro:after-swap", () => {
			applyTheme(getTheme());
		});
	})();
</script>

<script>
	import { supportsViewTransitions } from "astro:transitions/client";

	function updateIcons(isDark: boolean) {
		const sunIcon = document.getElementById("sun");
		const moonIcon = document.getElementById("moon");

		if (isDark) {
			sunIcon?.classList.remove("hidden");
			moonIcon?.classList.add("hidden");
		} else {
			sunIcon?.classList.add("hidden");
			moonIcon?.classList.remove("hidden");
		}
	}

	function handleToggleClick() {
		const element = document.documentElement;
		element.classList.toggle("dark");

		const isDark = element.classList.contains("dark");
		localStorage.setItem("theme", isDark ? "dark" : "light");
		updateIcons(isDark);
	}

	function initThemeToggle() {
		const isDark = document.documentElement.classList.contains("dark");
		updateIcons(isDark);
		document
			.getElementById("themeToggle")
			?.addEventListener("click", handleToggleClick);
	}

	// Gérer les transitions de page
	document.addEventListener("astro:page-load", () => {
		initThemeToggle();
	});

	// Mettre à jour les icônes après chaque transition
	document.addEventListener("astro:after-swap", () => {
		const isDark = document.documentElement.classList.contains("dark");
		updateIcons(isDark);
	});
</script>
