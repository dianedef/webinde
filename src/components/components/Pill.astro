---
import type { PillProps } from "../../utils/types/ui";
import colors from "../config/colors.json";

type Props = PillProps;

const lightColor =
	colors.light[Math.floor(Math.random() * colors.light.length)];
const darkColorRandom =
	colors.dark[Math.floor(Math.random() * colors.dark.length)];

const { color = lightColor, darkColor = darkColorRandom } = Astro.props;
---

<style define:vars={{ color, darkColor, shadowColor: '#9e4fff' }}>
	span.brutal-pill {
		filter: drop-shadow(3px 3px 0 rgb(0 0 0 / 1));
		user-select: none;
		background-color: var(--background-color, white);
		border-radius: 9999px;
		border: 2px solid var(--border-color, black);
		padding: 0.25rem 0.75rem;
		transition: all 0.3s ease-in-out;
		font-size: small;
		color: var(--text-color, black);
	}

	span.brutal-pill:hover {
		filter: drop-shadow(5px 5px 0 rgb(0 0 0 / 1));
		background-color: var(--color);
		transform: translateY(-2px);
	}

	/* Mode sombre */
	:global(.dark) span.brutal-pill {
		--background-color: black;
		--border-color: var(--shadowColor);
		--text-color: var(--shadowColor);
		filter: drop-shadow(3px 3px 0 var(--shadowColor));
	}

	:global(.dark) span.brutal-pill:hover {
		filter: drop-shadow(5px 5px 0 var(--shadowColor));
		background-color: var(--darkColor);
		color: var(--shadowColor);
	}

	/* Style pour les pills sélectionnées - Mode clair */
	:global(input:checked + a) span.brutal-pill {
		background-color: var(--selected-color, black) !important;
		color: white !important;
		border-color: black;
	}

	/* Style pour les pills sélectionnées - Mode sombre */
	:global(.dark input:checked + a) span.brutal-pill {
		background-color: var(--selected-color, var(--shadowColor)) !important;
		color: var(--shadowColor) !important;
		border-color: var(--shadowColor);
		filter: drop-shadow(3px 3px 0 var(--shadowColor));
	}
</style>

<span class="brutal-pill" data-color={color} data-dark-color={darkColor}>
	<slot />
</span>

<script>
	function setupPillColor() {
		const pills = document.querySelectorAll(".brutal-pill");
		pills.forEach((pill) => {
			const input = pill.closest("label")?.querySelector("input");
			if (!input) return;

			const color = document.documentElement.classList.contains("dark")
				? pill.getAttribute("data-dark-color")
				: pill.getAttribute("data-color");

			// Initialiser la couleur si déjà sélectionné
			if (input.checked && pill instanceof HTMLElement) {
				pill.style.setProperty("--selected-color", color);
			}

			input.addEventListener("change", () => {
				if (input.checked && pill instanceof HTMLElement) {
					pill.style.setProperty("--selected-color", color);
				} else if (pill instanceof HTMLElement) {
					pill.style.removeProperty("--selected-color");
				}
			});
		});
	}

	// Initialiser après le chargement de la page et les transitions
	document.addEventListener("astro:page-load", setupPillColor);

	// Initialiser après un changement de thème
	document.addEventListener("theme-changed", setupPillColor);

	// Fallback pour le chargement initial
	if (document.readyState === "loading") {
		document.addEventListener("DOMContentLoaded", setupPillColor);
	} else {
		setupPillColor();
	}
</script>
