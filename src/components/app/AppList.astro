---
import type { CollectionEntry } from 'astro:content';
import AppSummaryCard from './AppSummaryCard.astro';
import { getCollection } from 'astro:content';
import { Pill } from '@eliancodes/brutal-ui';

interface Props {
  posts: CollectionEntry<'app'>[];
  selectedTags?: string[];
}

const { posts, selectedTags = [] } = Astro.props;

const allPosts = await getCollection('app');
const allTags = [...new Set(allPosts.flatMap(post => post.data.tags))].sort();
---

<div class="tags-filter mb-8">
  <h3 class="text-lg font-semibold mb-2">Filtrer par tags :</h3>
  <div class="flex flex-wrap gap-2">
    {allTags.map(tag => (
      <label class="inline-flex items-center gap-2 cursor-pointer">
        <input 
          type="checkbox" 
          name="tag-filter" 
          value={tag} 
          class="hidden tag-checkbox"
        />
        <Pill>
          <span class="tag-label">{tag}</span>
        </Pill>
      </label>
    ))}
  </div>
</div>

<ul class='grid md:grid-cols-2 lg:grid-cols-3 gap-8'>
  {posts.map((post) => (
    <li 
      class:list={[
        "app",
        { "hidden": selectedTags.length > 0 && !selectedTags.some(tag => post.data.tags.includes(tag)) }
      ]}
      data-tags={JSON.stringify(post.data.tags)}
    >
      <AppSummaryCard post={post} />
    </li>
  ))}
</ul>

<style>
  label:has(input:checked) :global(.brutal-pill) {
    background-color: black !important;
    color: white;
    filter: drop-shadow(3px 3px 0 rgb(252, 252, 252));
    border-radius: 99px;
    border: 2px solid black;
    border: 2px solid rgb(255, 255, 255);
  }
  label:has(input:checked) :global(.brutal-pill):hover {
    filter: drop-shadow(5px 5px 0 rgb(255, 255, 255));
  }
</style>

<script>
  // Fonction d'initialisation des filtres
  function initializeFilters() {
    const checkboxes = document.querySelectorAll('input[name="tag-filter"]');
    const apps = document.querySelectorAll('.app');

    checkboxes.forEach(checkbox => {
      checkbox.addEventListener('change', (e) => {
        const label = (e.target as HTMLInputElement).closest('label');
        if (label) {
          label.classList.toggle('selected');
        }
        filterApps();
      });
    });

    function filterApps() {
      const selectedTags = Array.from(checkboxes)
        .filter((cb: HTMLInputElement) => cb.checked)
        .map((cb: HTMLInputElement) => cb.value);

      apps.forEach(app => {
        const appTags = JSON.parse(app.getAttribute('data-tags') || '[]');
        if (selectedTags.length === 0 || selectedTags.some(tag => appTags.includes(tag))) {
          app.classList.remove('hidden');
        } else {
          app.classList.add('hidden');
        }
      });
    }
  }

  // Initialiser les filtres au chargement initial
  initializeFilters();

  // RÃ©initialiser les filtres lors de la navigation avec view transitions
  document.addEventListener('astro:page-load', () => {
    initializeFilters();
  });
</script>
