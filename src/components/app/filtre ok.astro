---
import type { CollectionEntry } from 'astro:content';
import AppSummaryCard from './AppSummaryCard.astro';
import { getCollection } from 'astro:content';
import { Pill } from '@eliancodes/brutal-ui';

interface Props {
  posts: CollectionEntry<'app'>[];
  selectedTags?: string[];
}

const { posts, selectedTags = [] } = Astro.props;

const allPosts = await getCollection('app');
const allTags = [...new Set(allPosts.flatMap(post => post.data.tags))].sort();
---

<div class="tags-filter mb-8">
  <h3 class="text-lg font-semibold mb-2">Filtrer par tags :</h3>
  <div class="flex flex-wrap gap-2">
    {allTags.map(tag => (
      <Pill>
        <label class="cursor-pointer inline-flex items-center gap-2 px-3 py-1 rounded-full border-2 border-black hover:bg-black hover:text-white transition-colors">
          <input 
            type="checkbox" 
            name="tag-filter" 
            value={tag} 
            class="hidden tag-checkbox"
          />
          <span class="tag-label">{tag}</span>
        </label>
      </Pill>
    ))}
  </div>
</div>

<div class="apps">
  {posts.map((post) => (
    <div 
      class:list={[
        "app",
        { "hidden": selectedTags.length > 0 && !selectedTags.some(tag => post.data.tags.includes(tag)) }
      ]}
      data-tags={JSON.stringify(post.data.tags)}
    >
      <AppSummaryCard post={post} />
    </div>
  ))}
</div>

<style>
  input[type="checkbox"]:checked {
    background-color: #4F46E5;
    color: white;
  }

  .hidden {
    display: none;
  }

  label {
    transition: all 0.2s ease-in-out;
  }

  label.selected {
    background-color: black;
    color: white;
  }
</style>

<script>
  const checkboxes = document.querySelectorAll('input[name="tag-filter"]');
  const apps = document.querySelectorAll('.app');

  checkboxes.forEach(checkbox => {
    checkbox.addEventListener('change', (e) => {
      const label = (e.target as HTMLInputElement).closest('label');
      if (label) {
        label.classList.toggle('selected');
      }
      filterApps();
    });
  });

  function filterApps() {
    const selectedTags = Array.from(checkboxes)
      .filter((cb: HTMLInputElement) => cb.checked)
      .map((cb: HTMLInputElement) => cb.value);

    apps.forEach(app => {
      const appTags = JSON.parse(app.getAttribute('data-tags') || '[]');
      if (selectedTags.length === 0 || selectedTags.some(tag => appTags.includes(tag))) {
        app.classList.remove('hidden');
      } else {
        app.classList.add('hidden');
      }
    });
  }
</script>
