---
import type { CollectionEntry } from 'astro:content';
import BlogSummaryCard from './PostSummaryCard.astro';
import { getCollection } from 'astro:content';
import { Pill } from '@eliancodes/brutal-ui';
import { tagHierarchy } from '@components/tagHierarchy';

interface Props {
  posts: CollectionEntry<'posts'>[];
  selectedTags?: string[];
}

const { posts, selectedTags = [] } = Astro.props;

const allPosts = await getCollection('posts');
const mainTags = Object.keys(tagHierarchy);
---

<div class="tags-filter space-y-4">
  <!-- Tags principaux -->
  <div>
    <ul class="flex flex-wrap gap-4 justify-center">
      {mainTags.map(tag => (
        <li>
          <label class="cursor-pointer">
            <input 
              type="checkbox" 
              name="main-tag-filter" 
              value={tag} 
              class="hidden main-tag-checkbox"
            />
            <a class="sanchez inline-flex items-center pill-container">
              <Pill>{tagHierarchy[tag].label}</Pill>
            </a>
          </label>
        </li>
      ))}
    </ul>
  </div>

  <!-- Sous-tags (initialement cachés) -->
  {mainTags.map(mainTag => (
    <div class="subtags-container hidden" data-parent={mainTag}>
      <ul class="flex flex-wrap gap-4 justify-center">
        {Object.entries(tagHierarchy[mainTag].subtags).map(([key, { label }]) => (
          <li>
            <label class="cursor-pointer">
              <input 
                type="checkbox" 
                name="subtag-filter" 
                value={key} 
                data-parent={mainTag}
                class="hidden subtag-checkbox"
              />
              <a class="sanchez inline-flex items-center pill-container">
                <Pill>{label}</Pill>
              </a>
            </label>
          </li>
        ))}
      </ul>
    </div>
  ))}

  <div class="posts mt-8">
    {posts.map((post) => (
      <div 
        class="post"
        data-tags={JSON.stringify(post.data.tags)}
      >
        <BlogSummaryCard post={post} />
      </div>
    ))}
  </div>
</div>

<style>
  .hidden {
    display: none;
  }

  .pill-container :global(.brutal-pill) {
    transform: scale(1.5);
    margin-bottom: 0.5rem;
    transition: transform 0.2s ease-in-out;
  }

  .pill-container:hover :global(.brutal-pill) {
    transform: scale(1.5) translateX(-15px);
  }

  input:checked + a :global(.brutal-pill) {
    background-color: black;
    color: white;
  }
</style>

<script>
  const mainCheckboxes = document.querySelectorAll('.main-tag-checkbox');
  const subtagContainers = document.querySelectorAll('.subtags-container');
  const subtagCheckboxes = document.querySelectorAll('.subtag-checkbox');
  const posts = document.querySelectorAll('.post');

  // Gestion des tags principaux
  mainCheckboxes.forEach(checkbox => {
    checkbox.addEventListener('change', (e) => {
      // Afficher/masquer les sous-tags correspondants
      const mainTag = (e.target as HTMLInputElement).value;
      const subtagContainer = document.querySelector(`[data-parent="${mainTag}"]`);
      if (subtagContainer) {
        if ((e.target as HTMLInputElement).checked) {
          subtagContainer.classList.remove('hidden');
        } else {
          subtagContainer.classList.add('hidden');
          // Décocher tous les sous-tags de ce tag principal
          const checkboxes = subtagContainer.querySelectorAll('input[type="checkbox"]');
          checkboxes.forEach((cb: Element) => {
            if (cb instanceof HTMLInputElement) {
              cb.checked = false;
            }
          });
        }
      }
      
      filterPosts();
    });
  });

  // Gestion des sous-tags
  subtagCheckboxes.forEach(checkbox => {
    checkbox.addEventListener('change', () => {
      filterPosts();
    });
  });

  function filterPosts() {
    const selectedMainTags = Array.from(mainCheckboxes)
      .filter((cb: Element): cb is HTMLInputElement => cb instanceof HTMLInputElement && cb.checked)
      .map(cb => cb.value);

    const selectedSubtags = Array.from(subtagCheckboxes)
      .filter((cb: Element): cb is HTMLInputElement => cb instanceof HTMLInputElement && cb.checked)
      .map(cb => cb.value);

    posts.forEach(post => {
      const postTags = JSON.parse(post.getAttribute('data-tags') || '[]');
      
      // Si aucun filtre n'est sélectionné, afficher tous les posts
      if (selectedMainTags.length === 0 && selectedSubtags.length === 0) {
        post.classList.remove('hidden');
        return;
      }

      // Vérifier si le post correspond aux filtres sélectionnés
      const hasSelectedMainTag = selectedMainTags.length === 0 || 
        selectedMainTags.some(tag => postTags.includes(tag));
      const hasSelectedSubtag = selectedSubtags.length === 0 || 
        selectedSubtags.some(tag => postTags.includes(tag));

      if (hasSelectedMainTag && hasSelectedSubtag) {
        post.classList.remove('hidden');
      } else {
        post.classList.add('hidden');
      }
    });
  }
</script>
