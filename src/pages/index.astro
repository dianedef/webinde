---
import { getCollection } from "astro:content";
import Layout from "../layouts/Default.astro";
import FilterTags from "../components/components/FilterTags.astro";
import PostGrid from "../components/components/PostGrid.astro";
import { tagHierarchy } from "../components/tagHierarchy";
import colors from "../components/config/colors.json";

const ITEMS_PER_PAGE = 15;
const page = Number(Astro.url.searchParams.get("page") || "1");
const selectedTags = (Astro.url.searchParams.get("tags") || "")
	.split(",")
	.filter(Boolean);
const start = (page - 1) * ITEMS_PER_PAGE;

const allPosts = await getCollection("posts");
let filteredPosts = allPosts;

// Appliquer les filtres si des tags sont sélectionnés
if (selectedTags.length > 0) {
	filteredPosts = allPosts.filter((post) =>
		selectedTags.some((tag) =>
			post.data.tags.map((t) => t.toLowerCase()).includes(tag.toLowerCase()),
		),
	);
}

const totalPosts = filteredPosts.length;
const totalPages = Math.ceil(totalPosts / ITEMS_PER_PAGE);

const posts = filteredPosts.reverse().slice(start, start + ITEMS_PER_PAGE);

const mainTags = Object.keys(tagHierarchy);

// Meta robots : n'indexer que la première page sans filtres
const metaRobots =
	page === 1 && selectedTags.length === 0
		? "index, follow"
		: "noindex, follow";
---

<Layout
	title="Posts"
	description="Web'Indé | On this page you can find a collection of posts"
	pageTitle="Web'Indé Posts"
	metaRobots={metaRobots}
>
	<main
		class="page-background bg-gray-2 dark:bg-gray-8 p-6"
		transition:name="posts-container"
	>
		<FilterTags mainTags={mainTags} selectedTags={selectedTags} />
		<div id="current-page" data-page={page} class="hidden"></div>
		<div id="total-pages" data-total={totalPages} class="hidden"></div>
		<div id="selected-tags" data-tags={selectedTags.join(",")} class="hidden">
		</div>
		<PostGrid
			posts={posts}
			showLoadingSpinner={true}
			currentPage={page}
			totalPages={totalPages}
		/>
	</main>
</Layout>

<script>
	import colors from "../components/config/colors.json";

	function setRandomBackgroundColor() {
		const isDark = document.documentElement.classList.contains("dark");
		const colorArray = isDark ? colors.dark : colors.light;
		const randomColor =
			colorArray[Math.floor(Math.random() * colorArray.length)];

		const element = document.querySelector(".page-background") as HTMLElement;
		element?.style.setProperty("background-color", randomColor);
	}

	// Initialiser la couleur au chargement
	document.addEventListener("astro:page-load", setRandomBackgroundColor);

	// Changer la couleur quand le thème change
	document.addEventListener("theme-changed", setRandomBackgroundColor);
</script>

<style>
	.page-background {
		transition: background-color 0.3s ease;
	}

	.hidden {
		display: none;
	}

	.pill-container :global(.brutal-pill) {
		transform: scale(1.5);
		margin-bottom: 0.5rem;
		transition: transform 0.2s ease-in-out;
	}

	.pill-container:hover :global(.brutal-pill) {
		transform: scale(1.5) translateX(-15px);
	}

	input:checked + a :global(.brutal-pill) {
		background-color: black;
		color: white;
	}

	.loading-spinner {
		width: 50px;
		height: 50px;
		border: 5px solid #f3f3f3;
		border-top: 5px solid #3498db;
		border-radius: 50%;
		animation: spin 1s linear infinite;
	}

	@keyframes spin {
		0% {
			transform: rotate(0deg);
		}
		100% {
			transform: rotate(360deg);
		}
	}

	::view-transition-old(*),
	::view-transition-new(*) {
		animation-duration: 0.3s;
		animation-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
	}
</style>

<script>
	let currentPage = Number(
		document.querySelector("#current-page")?.getAttribute("data-page") || "1",
	);
	const totalPages = Number(
		document.querySelector("#total-pages")?.getAttribute("data-total") || "1",
	);
	const selectedTags = (
		document.querySelector("#selected-tags")?.getAttribute("data-tags") || ""
	)
		.split(",")
		.filter(Boolean);
	let isLoading = false;

	// Créer l'observer
	const observer = new IntersectionObserver(
		(entries) => {
			entries.forEach((entry) => {
				if (
					entry.isIntersecting &&
					!isLoading &&
					currentPage < totalPages
				) {
					loadNextPage();
				}
			});
		},
		{
			rootMargin: "100px",
			threshold: 0,
		},
	);

	async function loadNextPage() {
		isLoading = true;
		const nextPage = currentPage + 1;
		const tagsParam =
			selectedTags.length > 0 ? `&tags=${selectedTags.join(",")}` : "";

		try {
			const response = await fetch(`/?page=${nextPage}${tagsParam}`);
			const text = await response.text();

			const parser = new DOMParser();
			const doc = parser.parseFromString(text, "text/html");
			const newPosts = doc.querySelectorAll(".post");

			const postsContainer = document.querySelector(".posts-container");
			newPosts.forEach((post) => {
				postsContainer?.appendChild(post.cloneNode(true));
			});

			currentPage = nextPage;

			if (currentPage < totalPages) {
				const lastPost = postsContainer?.querySelector(".post:last-child");
				if (lastPost) observer.observe(lastPost);
			}
		} catch (error) {
			console.error("Erreur lors du chargement de la page suivante:", error);
		} finally {
			isLoading = false;
		}
	}

	// Gestion des filtres
	document.addEventListener("astro:page-load", () => {
		const filterForm = document.querySelector("form");
		if (filterForm) {
			filterForm.addEventListener("submit", (e) => {
				e.preventDefault();
				const formData = new FormData(filterForm);
				const selectedTags = Array.from(formData.getAll("tags"));
				const tagsParam =
					selectedTags.length > 0 ? `?tags=${selectedTags.join(",")}` : "";
				window.location.href = `/${tagsParam}`;
			});
		}

		const lastPost = document.querySelector(".post:last-child");
		if (lastPost && currentPage < totalPages) {
			observer.observe(lastPost);
		}
	});
</script>
