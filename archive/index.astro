---
import { getCollection } from "astro:content";
import Layout from "../layouts/Default.astro";
import FilterTags from "../components/components/FilterTags.vue";
import PostGrid from "../components/components/PostGrid.astro";
import { tagHierarchy } from "../components/tagHierarchy";
import type { Post, PostsUpdateEvent } from "../utils/types/content";

// Récupération des posts initiaux pour le SSG
const allPosts = await getCollection("posts");
const initialPosts = allPosts
	.sort((a, b) => b.data.pubDate.getTime() - a.data.pubDate.getTime())
	.slice(0, 15);

const mainTags = Object.keys(tagHierarchy);
const totalPages = Math.ceil(allPosts.length / 15);
---

<Layout title="Posts" description="Web'Indé |" pageTitle="Web'Indé Posts">
	<main class="page-background bg-gray-2 dark:bg-gray-8 p-6">
		<!-- Zone de contenu dynamique -->
		<div id="dynamic-content">
			<!-- Composant Vue pour le filtrage -->
			<FilterTags
				client:visible
				mainTags={mainTags}
				tagHierarchy={tagHierarchy}
				initialPosts={initialPosts}
			/>

			<!-- Rendu SSG initial -->
			<div id="ssg-content">
				<PostGrid
					posts={initialPosts}
					showLoadingSpinner={false}
					currentPage={1}
					totalPages={totalPages}
				/>
			</div>

			<!-- Zone pour le contenu dynamique -->
			<div id="vue-content" class="hidden">
				<div id="loading-spinner" class="flex justify-center mt-8 hidden">
					<div class="loading-spinner"></div>
				</div>
				<div id="posts-container"></div>
			</div>
		</div>
	</main>
</Layout>

<style>
	.page-background {
		transition: background-color 0.3s ease;
	}

	.loading-spinner {
		width: 50px;
		height: 50px;
		border: 5px solid #f3f3f3;
		border-top: 5px solid #3498db;
		border-radius: 50%;
		animation: spin 1s linear infinite;
	}

	@keyframes spin {
		0% {
			transform: rotate(0deg);
		}
		100% {
			transform: rotate(360deg);
		}
	}

	.hidden {
		display: none;
	}
</style>

<script>
	document.addEventListener("astro:page-load", () => {
		const ssgContent = document.getElementById("ssg-content");
		const vueContent = document.getElementById("vue-content");
		const loadingSpinner = document.getElementById("loading-spinner");
		const postsContainer = document.getElementById("posts-container");

		if (!ssgContent || !vueContent || !loadingSpinner || !postsContainer)
			return;

		// Écouter l'événement de mise à jour des posts
		window.addEventListener("posts-updated", ((event: PostsUpdateEvent) => {
			const { posts, isLoading, currentPage, totalPages } = event.detail;

			if (isLoading) {
				// Cacher le contenu SSG et afficher le spinner
				ssgContent.classList.add("hidden");
				vueContent.classList.remove("hidden");
				loadingSpinner.classList.remove("hidden");
				postsContainer.classList.add("hidden");
			} else {
				// Cacher le spinner
				loadingSpinner.classList.add("hidden");

				if (posts.length === 0) {
					// Afficher le message "aucun post trouvé"
					postsContainer.classList.remove("hidden");
					postsContainer.innerHTML = `
					<p class="text-center py-10">Aucun post trouvé</p>
				`;
			} else {
					// Afficher les posts avec PostGrid
					postsContainer.classList.remove("hidden");
					// Note: Ici nous devrions idéalement utiliser PostGrid.astro,
					// mais comme nous ne pouvons pas l'utiliser directement dans du JS,
					// nous devons recréer sa structure
					postsContainer.innerHTML = `
						<div class="posts mt-8">
							<ul class="grid md:grid-cols-2 lg:grid-cols-3 gap-8 p-4 rounded-lg">
								${posts
									.map(
										(post) => `
									<li class="post transition-transform hover:scale-[1.02] duration-200">
										<div class="p-4 rounded-lg transition-colors dark:bg-black brutal-card">
											<h3 class="post-title poppins text-lg md:text-xl">
												${post.data.title}
											</h3>
											<div class="post-image-container rounded-lg border-3 my-4 h-56 overflow-hidden">
												<img
													src="${post.data.imgUrl.src}"
													alt="${post.data.title}"
													class="rounded h-full w-full object-cover"
												/>
											</div>
											<p class="post-description poppins">
												${post.data.description}
											</p>
											<div class="flex justify-end my-4">
												<a href="/${post.id}" class="brutal-btn px-4 py-2">
													<span>Lire plus &rarr;</span>
												</a>
											</div>
											<div class="hidden sm:inline-block">
												<div class="flex justify-between items-center">
													<ul class="flex flex-wrap gap-4 mt-2">
														${post.data.tags
															.map(
																(tag) => `
															<li>
																<a class="sanchez" href="/tag/${tag.toLowerCase()}/1">
																	<span class="text-sm bg-gray-200 dark:bg-gray-700 px-2 py-1 rounded">
																		${tag}
																	</span>
																</a>
															</li>
														`,
															)
															.join("")}
													</ul>
													${
														post.data.draft
															? `
														<span class="draft-badge bg-green rounded-full border-2 py-1 px-4 text-sm card-shadow">
															Brouillon
														</span>
													`
															: ""
													}
												</div>
											</div>
										</div>
									</li>
								`,
									)
									.join("")}
							</ul>
						</div>
					`;
				}
			}
		}) as EventListener);
	});
</script>
